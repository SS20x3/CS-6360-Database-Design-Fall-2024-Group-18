drop view if exists graph_2;create view graph_2 as (select src, dst, score, score maxScore from graph);drop view if exists graph_1;create view graph_1 as (select R.src, R.dst, R.score, R.score+S.maxScore maxScore from graph R, (select src, max(score) maxScore from graph_2 group by src) S where R.dst=S.src);drop view if exists graph_0;create view graph_0 as (select R.src, R.dst, R.score, R.score+S.maxScore maxScore from graph R, (select src, max(maxScore) maxScore from graph_1 group by src) S where R.dst=S.src order by maxScore desc limit 10);drop table if exists graph_0_joined;create table graph_0_joined as (select * from graph_0);drop table if exists graph_1_id;create table graph_1_id as (with R as (select dst, max(score) maxScore from graph_0_joined group by dst), T as ( select S.src as src, S.dst as dst, S.score as score, R.maxScore+S.maxScore as maxScore from R, graph_1 S where R.dst = S.src order by R.maxScore+S.maxScore desc limit 10) select src, dst, score, maxScore, row_number() over(partition by src order by maxScore desc) as id from T);create index id_index_1 on graph_1_id (id);drop view if exists S0;drop view if exists T0;create view S0 as (select * from graph_1_id where id<=2);create view T0 as (select R.src src, R.dst joinNode, S.dst dst, S.id id, R.score lScore, S.score rScore, lScore+rScore score from graph_0_joined R, S0 S where R.dst=S.src order by score desc limit 10);drop view if exists R1;drop view if exists S1;drop view if exists T1;create view R1 as (select src, joinNode as dst, lscore as score from T0 where id=2);create view S1 as (select * from graph_1_id where id>2 and id<=4);create view T1 as (with RjS as (select R.src src, R.dst joinNode, S.dst dst, S.id id, R.score lScore, S.score rScore, lScore+rScore score from R1 R,  S1 S where R.dst=S.src) (select * from T0) union (select * from RjS) order by score desc limit 10);drop view if exists R2;drop view if exists S2;drop view if exists T2;create view R2 as (select src, joinNode as dst, lscore as score from T1 where id=4);create view S2 as (select * from graph_1_id where id>4 and id<=8);create view T2 as (with RjS as (select R.src src, R.dst joinNode, S.dst dst, S.id id, R.score lScore, S.score rScore, lScore+rScore score from R2 R,  S2 S where R.dst=S.src) (select * from T1) union (select * from RjS) order by score desc limit 10);drop view if exists R3;drop view if exists S3;drop view if exists T3;create view R3 as (select src, joinNode as dst, lscore as score from T2 where id=8);create view S3 as (select * from graph_1_id where id>8 and id<=16);create view T3 as (with RjS as (select R.src src, R.dst joinNode, S.dst dst, S.id id, R.score lScore, S.score rScore, lScore+rScore score from R3 R,  S3 S where R.dst=S.src) (select * from T2) union (select * from RjS) order by score desc limit 10);drop table if exists graph_1_joined;create table graph_1_joined as (select src, dst, score from T3);drop table if exists graph_2_id;create table graph_2_id as (with R as (select dst, max(score) maxScore from graph_1_joined group by dst), T as ( select S.src as src, S.dst as dst, S.score as score, R.maxScore+S.maxScore as maxScore from R, graph_2 S where R.dst = S.src order by R.maxScore+S.maxScore desc limit 10) select src, dst, score, maxScore, row_number() over(partition by src order by maxScore desc) as id from T);create index id_index_2 on graph_2_id (id);drop view if exists S0;drop view if exists T0;create view S0 as (select * from graph_2_id where id<=2);create view T0 as (select R.src src, R.dst joinNode, S.dst dst, S.id id, R.score lScore, S.score rScore, lScore+rScore score from graph_1_joined R, S0 S where R.dst=S.src order by score desc limit 10);drop view if exists R1;drop view if exists S1;drop view if exists T1;create view R1 as (select src, joinNode as dst, lscore as score from T0 where id=2);create view S1 as (select * from graph_2_id where id>2 and id<=4);create view T1 as (with RjS as (select R.src src, R.dst joinNode, S.dst dst, S.id id, R.score lScore, S.score rScore, lScore+rScore score from R1 R,  S1 S where R.dst=S.src) (select * from T0) union (select * from RjS) order by score desc limit 10);drop view if exists R2;drop view if exists S2;drop view if exists T2;create view R2 as (select src, joinNode as dst, lscore as score from T1 where id=4);create view S2 as (select * from graph_2_id where id>4 and id<=8);create view T2 as (with RjS as (select R.src src, R.dst joinNode, S.dst dst, S.id id, R.score lScore, S.score rScore, lScore+rScore score from R2 R,  S2 S where R.dst=S.src) (select * from T1) union (select * from RjS) order by score desc limit 10);drop view if exists R3;drop view if exists S3;drop view if exists T3;create view R3 as (select src, joinNode as dst, lscore as score from T2 where id=8);create view S3 as (select * from graph_2_id where id>8 and id<=16);create view T3 as (with RjS as (select R.src src, R.dst joinNode, S.dst dst, S.id id, R.score lScore, S.score rScore, lScore+rScore score from R3 R,  S3 S where R.dst=S.src) (select * from T2) union (select * from RjS) order by score desc limit 10);drop table if exists graph_2_joined;create table graph_2_joined as (select src, dst, score from T3);select * from graph_2_joined;
